<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	</head>
	<body style="margin-top: 0; margin-left: 0;">

		<div id="container"></div>

		<video id="video" loop muted crossOrigin="anonymous" webkit-playsinline style="display:none">
			<source src="https://kdementiev-reinvently.github.io/video.mp4">
		</video>

		<script type="module">

			import * as THREE from 'https://threejs.org/build/three.module.js';

			import Stats from 'https://threejs.org/examples/jsm/libs/stats.module.js';
			import { GLTFLoader } from 'https://threejs.org/examples/jsm/loaders/GLTFLoader.js';

			var camera, scene, renderer;

			var videoContainer;

			var model;
			var mixer;
			var clock;
			var animation;

			var isUserInteracting = false,
				lon = 90, lat = 0,
				phi = 0, theta = 0,
				distance = 50,
				onPointerDownPointerX = 0,
				onPointerDownPointerY = 0,
				onPointerDownLon = 0,
				onPointerDownLat = 0;

			var stats;

			var action;

			init();
			animate();

			function init() {

				clock = new THREE.Clock();

				var innerWidth = 256;
				var innerHeight = 512;

				var container, mesh;

				container = document.getElementById( 'container' );

				camera = new THREE.PerspectiveCamera( 55, innerWidth / innerHeight, 1, 50 );
				camera.target = new THREE.Vector3( 0, 0, 0 );

				scene = new THREE.Scene();

				var geometry = new THREE.PlaneBufferGeometry(49, 49, 2);

				// var geometry = new THREE.SphereBufferGeometry( 500, 60, 40 );
				// invert the geometry on the x-axis so that all of the faces point inward
				geometry.scale( 1, 1, 1 );


				var video = document.getElementById( 'video' );
				video.play();

				videoContainer = video

				var texture = new THREE.VideoTexture( video );
				var material = new THREE.MeshBasicMaterial( { map: texture } );

				mesh = new THREE.Mesh( geometry, material );
				scene.add( mesh );

				mesh.position.set(12,0,0);

				var light = new THREE.AmbientLight( 0xffffff, 3 ); // soft white light
				scene.add( light );


				renderer = new THREE.WebGLRenderer();
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( innerWidth, innerHeight );
				container.appendChild( renderer.domElement );

				// stats
				stats = new Stats();
				container.appendChild( stats.dom );

				load();

			}

			function load() {
				var loader = new GLTFLoader();
					loader.load( 'https://kdementiev-reinvently.github.io/face-scene.glb', function ( gltf ) {
						model = gltf.scene;

						var planeMesh = model.children[0];
						var material = planeMesh.material

						scene.add( model );

						var scaling = 15.0;

						model.scale.set(scaling,scaling,-scaling);

						// model.position.set(0, -10, scaling);

						// mixer = new THREE.AnimationMixer( model );

						// animation = gltf.animations[1];

						// action = mixer.clipAction(animation);

						// action.clampWhenFinished = true;
						// action.loop = THREE.LoopRepeat;
						// action.play();

						// createGUI( model, gltf.animations );
					}, undefined, function ( e ) {
						console.error( e );
					} );
			}

			function animate() {

				stats.update();

				var dt = clock.getDelta();
				// if ( mixer ) mixer.update( dt );

				var videoTime = videoContainer.currentTime / videoContainer.duration;
				if ( mixer ) { 
					
					var resultTime = videoTime * 0.5 * animation.duration;
					action.time = resultTime;
					mixer.update(0);
				}

				requestAnimationFrame( animate );

				update();

			}

			function update() {

				lat = Math.max( - 85, Math.min( 85, lat ) );
				phi = THREE.Math.degToRad( 90 - lat );
				theta = THREE.Math.degToRad( lon );

				camera.position.x = distance * Math.sin( phi ) * Math.cos( theta );
				camera.position.y = distance * Math.cos( phi );
				camera.position.z = distance * Math.sin( phi ) * Math.sin( theta );

				camera.lookAt( camera.target );

				renderer.render( scene, camera );

			}

		</script>
	</body>
</html>
